version: 2

models:
  - name: mart_nhl_team_trends
    description: NHL team performance trends analysis
    tests:
      - unique:
          column_name: "team_name || '-' || game_id"
      - not_null:
          column_name: team_name
    columns:
      - name: game_id
        tests:
          - not_null
          - relationships:
              to: ref('fct_games')
              field: game_id

      - name: avg_goals_per_game
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10

      - name: avg_assists_per_game
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 15

      - name: avg_save_percentage
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0.7
              max_value: 1.0

      - name: win_percentage
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 100

      - name: total_overtime_games
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 82

      # Custom tests for hockey-specific metrics
      - name: hockey_metrics
        tests:
          - dbt_utils.expression_is_true:
              expression: "overtime_wins <= total_overtime_games"
          - dbt_utils.expression_is_true:
              expression: "total_wins <= total_games"
          - dbt_utils.expression_is_true:
              expression: "avg_assists_per_goal >= 0"
